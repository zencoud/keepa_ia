{% extends "base.html" %}
{% load static %}
{% load messages_tags %}
{% load humanize %}

{% block title %}{{ product.title|truncatechars:50 }} - Keepa IA{% endblock %}

{% block content %}
<!-- Header -->
{% component "header" %}{% endcomponent %}

<!-- Main Content -->
<main class="min-h-screen pb-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumbs -->
        {% component "breadcrumbs" items=breadcrumbs %}{% endcomponent %}
        
        <!-- Messages -->
        {% render_flash_messages %}
        
        <!-- Product Header -->
        <div class="glass-card glass-card-hover mb-8 p-8 animate-slide-up">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Product Image -->
                <div class="relative">
                    {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.title }}" 
                             class="w-full h-auto max-h-96 object-contain rounded-[40px] border border-white/20 bg-white/5 p-4"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    {% endif %}
                    <div class="{% if product.image_url %}hidden{% endif %} w-full h-96 bg-white/5 rounded-[40px] border border-white/20 flex items-center justify-center">
                        <svg class="w-32 h-32 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
                
                <!-- Product Info -->
                <div>
                    <h1 class="text-3xl font-bold text-white mb-4">{{ product.title }}</h1>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">ASIN:</span>
                            <span class="font-mono text-white bg-white/10 px-3 py-1 rounded-[40px] text-sm">{{ product.asin }}</span>
                        </div>
                        
                        {% if product.brand %}
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Marca:</span>
                            <span class="text-white font-medium">{{ product.brand }}</span>
                        </div>
                        {% endif %}
                        
                        {% if product.binding %}
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Categoría:</span>
                            <span class="text-white font-medium">{{ product.binding }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <!-- Precio -->
                        <div class="bg-keepa-blue-500/20 rounded-[40px] p-4 border border-keepa-blue-500/30">
                            <div class="text-2xl font-bold text-keepa-blue-300 mb-1">
                                {% if product.current_price_new %}
                                    {{ product.get_price_display }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Precio Actual</div>
                        </div>
                        
                        <!-- Rating -->
                        <div class="bg-keepa-green-500/20 rounded-[40px] p-4 border border-keepa-green-500/30">
                            <div class="text-2xl font-bold text-keepa-green-300 mb-1">
                                {% if product.rating %}
                                    {{ product.rating }} ⭐
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Calificación</div>
                        </div>
                        
                        <!-- Reviews -->
                        <div class="bg-keepa-orange-500/20 rounded-[40px] p-4 border border-keepa-orange-500/30">
                            <div class="text-2xl font-bold text-keepa-orange-300 mb-1">
                                {% if product.review_count %}
                                    {{ product.review_count|intcomma }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Reseñas</div>
                        </div>
                        
                        <!-- Sales Rank -->
                        <div class="bg-purple-500/20 rounded-[40px] p-4 border border-purple-500/30">
                            <div class="text-2xl font-bold text-purple-300 mb-1">
                                {% if product.sales_rank_current %}
                                    #{{ product.sales_rank_current|intcomma }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Sales Rank</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <a href="{% url 'products:create_alert' product.asin %}" class="btn-primary flex-1 text-center flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            Crear Alerta de Precio
                        </a>
                        <a href="{{ product.get_refresh_url }}" class="btn-secondary px-6 flex items-center justify-center" title="Actualizar datos">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="grid gap-8 mb-8">
            <!-- Price History Chart -->
            {% if product.price_history %}
            <div class="glass-card p-6 animate-slide-up-delay-100">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-keepa-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                    </svg>
                    Historial de Precios
                </h2>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            <!-- Sales Rank History Chart -->
            {% if product.sales_rank_history %}
            <div class="glass-card p-6 animate-slide-up-delay-200">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    Historial de Sales Rank
                </h2>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="salesRankChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            <!-- Rating History Chart -->
            {% if product.rating_history %}
            <div class="glass-card p-6 animate-slide-up-delay-300">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-keepa-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    Historial de Calificaciones
                </h2>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Additional Info -->
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Categories -->
            {% if product.categories %}
            <div class="glass-card p-6 animate-fade-in-delay-400">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-keepa-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Categorías
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% for category in product.categories %}
                        <span class="bg-white/10 text-white px-3 py-1 rounded-[40px] text-sm">{{ category }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Last Updated -->
            <div class="glass-card p-6 animate-fade-in-delay-500">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-keepa-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Información
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Última actualización:</span>
                        <span class="text-white">{{ product.last_updated|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Consultado por primera vez:</span>
                        <span class="text-white">{{ product.created_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
{% component "footer" %}{% endcomponent %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Configuración común para todas las gráficas
    const commonChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                labels: {
                    color: 'rgb(226, 232, 240)',
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'rgb(226, 232, 240)',
                bodyColor: 'rgb(226, 232, 240)',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1
            }
        },
        scales: {
            x: {
                ticks: {
                    color: 'rgb(148, 163, 184)',
                    maxRotation: 45,
                    minRotation: 45,
                    maxTicksLimit: 10
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            }
        }
    };

    {% if product.price_history %}
    // Gráfica de Precio
    const priceCtx = document.getElementById('priceChart');
    const priceHistory = {{ price_history_json|safe }};
    
    const newPrices = priceHistory.NEW || {};
    const amazonPrices = priceHistory.AMAZON || {};
    const usedPrices = priceHistory.USED || {};
    
    // Combinar todos los precios para calcular rango
    const allPrices = [
        ...(newPrices.prices || []).map(p => p / 100),
        ...(amazonPrices.prices || []).map(p => p / 100),
        ...(usedPrices.prices || []).map(p => p / 100)
    ].filter(p => p > 0);
    
    const minPrice = Math.min(...allPrices);
    const maxPrice = Math.max(...allPrices);
    const priceRange = maxPrice - minPrice;
    const priceMin = Math.max(0, minPrice - (priceRange * 0.1));
    const priceMax = maxPrice + (priceRange * 0.1);
    
    new Chart(priceCtx, {
        type: 'line',
        data: {
            labels: newPrices.formatted_times || amazonPrices.formatted_times || [],
            datasets: [
                {
                    label: 'Precio Nuevo',
                    data: (newPrices.prices || []).map(p => p / 100),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                },
                {
                    label: 'Precio Amazon',
                    data: (amazonPrices.prices || []).map(p => p / 100),
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                },
                {
                    label: 'Precio Usado',
                    data: (usedPrices.prices || []).map(p => p / 100),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                }
            ]
        },
        options: {
            ...commonChartOptions,
            scales: {
                ...commonChartOptions.scales,
                y: {
                    beginAtZero: false,
                    min: priceMin,
                    max: priceMax,
                    ticks: {
                        color: 'rgb(148, 163, 184)',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}
    
    {% if product.sales_rank_history %}
    // Gráfica de Sales Rank
    const salesRankCtx = document.getElementById('salesRankChart');
    const salesRankHistory = {{ sales_rank_history_json|safe }};
    
    const salesRankData = salesRankHistory.values || [];
    const salesRankTimes = salesRankHistory.formatted_times || [];
    
    // Calcular rango para Sales Rank (nota: menor es mejor)
    const validSalesRanks = salesRankData.filter(s => s > 0);
    if (validSalesRanks.length > 0) {
        const minSalesRank = Math.min(...validSalesRanks);
        const maxSalesRank = Math.max(...validSalesRanks);
        const salesRankRange = maxSalesRank - minSalesRank;
        const salesRankMin = Math.max(0, minSalesRank - (salesRankRange * 0.1));
        const salesRankMax = maxSalesRank + (salesRankRange * 0.1);
        
        new Chart(salesRankCtx, {
            type: 'line',
            data: {
                labels: salesRankTimes,
                datasets: [{
                    label: 'Sales Rank',
                    data: salesRankData,
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                ...commonChartOptions,
                scales: {
                    ...commonChartOptions.scales,
                    y: {
                        beginAtZero: false,
                        min: salesRankMin,
                        max: salesRankMax,
                        reverse: false,
                        ticks: {
                            color: 'rgb(148, 163, 184)',
                            callback: function(value) {
                                return '#' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if product.rating_history %}
    // Gráfica de Rating
    const ratingCtx = document.getElementById('ratingChart');
    const ratingHistory = {{ rating_history_json|safe }};
    
    const ratingData = ratingHistory.values || [];
    const ratingTimes = ratingHistory.formatted_times || [];
    
    new Chart(ratingCtx, {
        type: 'line',
        data: {
            labels: ratingTimes,
            datasets: [{
                label: 'Calificación',
                data: ratingData,
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.1,
                stepped: 'before',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            ...commonChartOptions,
            scales: {
                ...commonChartOptions.scales,
                y: {
                    beginAtZero: false,
                    min: 0,
                    max: 5,
                    ticks: {
                        color: 'rgb(148, 163, 184)',
                        stepSize: 0.5,
                        callback: function(value) {
                            return value.toFixed(1) + ' ⭐';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}


{% extends "base.html" %}
{% load static %}
{% load messages_tags %}
{% load humanize %}

{% block title %}{{ product.title|truncatechars:50 }} - Keepa IA{% endblock %}

{% block content %}
<!-- Header -->
{% component "header" %}{% endcomponent %}

<!-- Main Content -->
<main class="min-h-screen pb-12" data-product-asin="{{ product.asin }}">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumbs -->
        {% component "breadcrumbs" items=breadcrumbs %}{% endcomponent %}
        
        <!-- Messages -->
        {% render_flash_messages %}
        
        <!-- Product Header -->
        <div class="glass-card glass-card-hover mb-8 p-8 animate-slide-up">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Product Image -->
                <div class="relative">
                    {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.title }}" 
                             class="w-full h-auto max-h-96 object-contain rounded-[40px] border border-white/20 bg-white/5 p-4"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    {% endif %}
                    <div class="{% if product.image_url %}hidden{% endif %} w-full h-96 bg-white/5 rounded-[40px] border border-white/20 flex items-center justify-center">
                        <svg class="w-32 h-32 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
                
                <!-- Product Info -->
                <div>
                    <h1 class="text-3xl font-bold text-white mb-4">{{ product.title }}</h1>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">ASIN:</span>
                            <span class="font-mono text-white bg-white/10 px-3 py-1 rounded-[40px] text-sm">{{ product.asin }}</span>
                        </div>
                        
                        {% if product.brand %}
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Marca:</span>
                            <span class="text-white font-medium">{{ product.brand }}</span>
                        </div>
                        {% endif %}
                        
                        {% if product.binding %}
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Categoría:</span>
                            <span class="text-white font-medium">{{ product.binding }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <!-- Precio -->
                        <div class="bg-keepa-blue-500/20 rounded-[40px] p-4 border border-keepa-blue-500/30">
                            <div class="text-2xl font-bold text-keepa-blue-300 mb-1">
                                {% if product.current_price_new %}
                                    {{ product.get_price_display }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Precio Actual</div>
                        </div>
                        
                        <!-- Rating -->
                        <div class="bg-keepa-green-500/20 rounded-[40px] p-4 border border-keepa-green-500/30">
                            <div class="text-2xl font-bold text-keepa-green-300 mb-1">
                                {% if product.rating %}
                                    {{ product.rating }} ⭐
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Calificación</div>
                        </div>
                        
                        <!-- Reviews -->
                        <div class="bg-keepa-orange-500/20 rounded-[40px] p-4 border border-keepa-orange-500/30">
                            <div class="text-2xl font-bold text-keepa-orange-300 mb-1">
                                {% if product.review_count %}
                                    {{ product.review_count|intcomma }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Reseñas</div>
                        </div>
                        
                        <!-- Sales Rank -->
                        <div class="bg-purple-500/20 rounded-[40px] p-4 border border-purple-500/30">
                            <div class="text-2xl font-bold text-purple-300 mb-1">
                                {% if product.sales_rank_current %}
                                    #{{ product.sales_rank_current|intcomma }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="text-xs text-slate-300">Sales Rank</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <a href="{% url 'products:create_alert' product.asin %}" class="btn-primary flex-1 text-center flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            Crear Alerta de Precio
                        </a>
                        <a href="{{ product.get_refresh_url }}" class="btn-secondary px-6 flex items-center justify-center" title="Actualizar datos">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Summary Section -->
        <div class="glass-card p-8 mb-8 animate-slide-up-delay-100 relative overflow-hidden" id="ai-summary-container">
            <!-- AI Badge -->
            <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-2 bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 rounded-[40px] px-4 py-2">
                    <svg class="w-5 h-5 text-purple-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <span class="text-sm font-semibold text-purple-300">Análisis con IA</span>
                </div>
                <div class="flex-1"></div>
                <div class="text-xs text-slate-400">GPT-4o</div>
            </div>
            
            {% if product.ai_summary %}
            <!-- Summary Text (mostrado instantáneamente, sin typing en recarga) -->
            <div class="bg-white/5 rounded-[40px] p-6 border border-white/10" id="summary-content">
                <div id="ai-summary-text" class="text-white text-lg leading-relaxed">
                    {{ product.ai_summary }}
                </div>
            </div>
            
            <!-- Información de generación y botón regenerar -->
            <div class="flex items-center justify-between mt-4 text-sm">
                <div class="text-slate-400">
                    {% if product.ai_summary_generated_at %}
                    Generado el {{ product.ai_summary_generated_at|date:"d/m/Y H:i" }}
                    {% endif %}
                </div>
                <button id="regenerate-ai-summary-btn" class="btn-secondary text-sm px-4 py-2 inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Regenerar Análisis
                </button>
            </div>
            {% else %}
            <!-- Generate Button -->
            <div class="bg-white/5 rounded-[40px] p-6 border border-white/10 text-center" id="summary-content">
                <p class="text-slate-300 mb-4">Genera un análisis inteligente del historial de precios con IA</p>
                <button id="generate-ai-summary-btn" class="btn-primary inline-flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Generar Reporte con IA
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- Charts Grid -->
        <div class="grid gap-8 mb-8">
            <!-- Price History Chart -->
            {% if product.price_history %}
            <div class="glass-card p-6 animate-slide-up-delay-100">
                <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <svg class="w-6 h-6 mr-2 text-keepa-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                        </svg>
                        Historial de Precios
                    </h2>
                    <div class="flex gap-2 flex-wrap">
                        <button class="date-filter-btn price-chart-btn active bg-keepa-blue-500/30 border border-keepa-blue-500/50 text-white px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-keepa-blue-500/40 transition-colors" data-range="1m" data-chart="price">
                            1 Mes
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3m" data-chart="price">
                            3 Meses
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="6m" data-chart="price">
                            6 Meses
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="1y" data-chart="price">
                            1 Año
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="2y" data-chart="price">
                            2 Años
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3y" data-chart="price">
                            3 Años
                        </button>
                        <button class="date-filter-btn price-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="all" data-chart="price">
                            Todo
                        </button>
                    </div>
                </div>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            <!-- Sales Rank History Chart -->
            {% if product.sales_rank_history %}
            <div class="glass-card p-6 animate-slide-up-delay-200">
                <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        Historial de Sales Rank
                    </h2>
                    <div class="flex gap-2 flex-wrap">
                        <button class="date-filter-btn salesrank-chart-btn active bg-purple-500/30 border border-purple-500/50 text-white px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-purple-500/40 transition-colors" data-range="1m" data-chart="salesrank">
                            1 Mes
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3m" data-chart="salesrank">
                            3 Meses
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="6m" data-chart="salesrank">
                            6 Meses
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="1y" data-chart="salesrank">
                            1 Año
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="2y" data-chart="salesrank">
                            2 Años
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3y" data-chart="salesrank">
                            3 Años
                        </button>
                        <button class="date-filter-btn salesrank-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="all" data-chart="salesrank">
                            Todo
                        </button>
                    </div>
                </div>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="salesRankChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            <!-- Rating History Chart -->
            {% if product.rating_history %}
            <div class="glass-card p-6 animate-slide-up-delay-300">
                <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <svg class="w-6 h-6 mr-2 text-keepa-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                        Historial de Calificaciones
                    </h2>
                    <div class="flex gap-2 flex-wrap">
                        <button class="date-filter-btn rating-chart-btn active bg-keepa-green-500/30 border border-keepa-green-500/50 text-white px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-keepa-green-500/40 transition-colors" data-range="1m" data-chart="rating">
                            1 Mes
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3m" data-chart="rating">
                            3 Meses
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="6m" data-chart="rating">
                            6 Meses
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="1y" data-chart="rating">
                            1 Año
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="2y" data-chart="rating">
                            2 Años
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="3y" data-chart="rating">
                            3 Años
                        </button>
                        <button class="date-filter-btn rating-chart-btn bg-white/10 border border-white/20 text-slate-300 px-4 py-2 rounded-[40px] text-sm font-medium hover:bg-white/20 transition-colors" data-range="all" data-chart="rating">
                            Todo
                        </button>
                    </div>
                </div>
                <div class="bg-white/5 rounded-[40px] p-6" style="height: 400px;">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Additional Info -->
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Categories -->
            {% if product.categories %}
            <div class="glass-card p-6 animate-fade-in-delay-400">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-keepa-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Categorías
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% for category in product.categories %}
                        <span class="bg-white/10 text-white px-3 py-1 rounded-[40px] text-sm">{{ category }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Last Updated -->
            <div class="glass-card p-6 animate-fade-in-delay-500">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-keepa-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Información
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Última actualización:</span>
                        <span class="text-white">{{ product.last_updated|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Consultado por primera vez:</span>
                        <span class="text-white">{{ product.created_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
{% component "footer" %}{% endcomponent %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Función para el efecto de typing
    function startTypingEffect(text, elementId, cursorId) {
        const summaryElement = document.getElementById(elementId);
        const cursorElement = document.getElementById(cursorId);
        
        if (!summaryElement) return;
        
        let currentIndex = 0;
        const typingSpeed = 20; // milliseconds per character
        
        // Limpiar el contenido inicial
        summaryElement.textContent = '';
        
        function typeNextCharacter() {
            if (currentIndex < text.length) {
                summaryElement.textContent += text[currentIndex];
                currentIndex++;
                setTimeout(typeNextCharacter, typingSpeed);
            } else {
                // Ocultar el cursor cuando termine de escribir
                if (cursorElement) {
                    setTimeout(() => {
                        cursorElement.style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // Iniciar el efecto de typing después de un pequeño delay
        setTimeout(typeNextCharacter, 300);
    }
    
    // Función para generar/regenerar resumen
    function generateSummary(button, isRegenerate = false) {
        // Obtener el ASIN del producto
        const asin = '{{ product.asin }}';
        const summaryContent = document.getElementById('summary-content');
        const container = document.getElementById('ai-summary-container');
        
        // Deshabilitar el botón y mostrar loading
        button.disabled = true;
        const originalButtonContent = button.innerHTML;
        button.innerHTML = `
                    <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
            ${isRegenerate ? 'Regenerando' : 'Generando'} análisis con IA...
        `;
        
        // Obtener el CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.cookie.split('; ')
                            .find(row => row.startsWith('csrftoken='))
                            ?.split('=')[1];
        
        // Hacer la petición AJAX
        fetch(`/products/generate-ai-summary/${asin}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Crear nuevo contenido con el resumen y botón regenerar
                const newContent = `
                    <div class="bg-white/5 rounded-[40px] p-6 border border-white/10" id="summary-content">
                        <div id="ai-summary-text" class="text-white text-lg leading-relaxed"></div>
                        <div id="typing-cursor" class="inline-block w-0.5 h-6 bg-purple-400 animate-pulse ml-1"></div>
                    </div>
                    <div class="flex items-center justify-between mt-4 text-sm">
                        <div class="text-slate-400">
                            Generado el ${data.generated_at}
                        </div>
                        <button id="regenerate-ai-summary-btn" class="btn-secondary text-sm px-4 py-2 inline-flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Regenerar Análisis
                        </button>
                    </div>
                `;
                
                // Reemplazar todo el contenido interno del container
                const badge = container.querySelector('.flex.items-center.gap-2.mb-4');
                container.innerHTML = '';
                container.appendChild(badge);
                container.innerHTML += newContent;
                
                // Iniciar el efecto de typing
                startTypingEffect(data.summary, 'ai-summary-text', 'typing-cursor');
                
                // Agregar listener al nuevo botón de regenerar
                document.getElementById('regenerate-ai-summary-btn').addEventListener('click', function() {
                    generateSummary(this, true);
                });
            } else {
                // Mostrar error
                summaryContent.innerHTML = `
                    <div class="text-center">
                        <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-red-300 mb-4">${data.error}</p>
                        <button onclick="location.reload()" class="btn-secondary">
                            Intentar de nuevo
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            summaryContent.innerHTML = `
                <div class="text-center">
                    <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-red-300 mb-4">Error al generar el resumen. Por favor, intenta de nuevo.</p>
                    <button onclick="location.reload()" class="btn-secondary">
                        Intentar de nuevo
                    </button>
                </div>
            `;
        });
    }
    
    // Event listeners al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar el botón de generar resumen (primera vez)
        const generateBtn = document.getElementById('generate-ai-summary-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', function() {
                generateSummary(this, false);
            });
        }
        
        // Manejar el botón de regenerar resumen (si ya existe)
        const regenerateBtn = document.getElementById('regenerate-ai-summary-btn');
        if (regenerateBtn) {
            regenerateBtn.addEventListener('click', function() {
                generateSummary(this, true);
            });
        }
    });
    
    // Variables globales para almacenar datos originales y gráficas
    let priceChart = null;
    let salesRankChart = null;
    let ratingChart = null;
    
    // Datos originales completos
    let originalPriceHistory = null;
    let originalSalesRankHistory = null;
    let originalRatingHistory = null;
    
    // Rangos de fechas actuales por gráfico (por defecto: 1 mes)
    let currentDateRange = {
        price: '1m',
        salesrank: '1m',
        rating: '1m'
    };
    
    // Función para calcular la fecha de corte según el rango
    function getCutoffDate(range) {
        const now = new Date();
        const cutoff = new Date();
        
        switch(range) {
            case '1m':
                cutoff.setMonth(now.getMonth() - 1);
                break;
            case '3m':
                cutoff.setMonth(now.getMonth() - 3);
                break;
            case '6m':
                cutoff.setMonth(now.getMonth() - 6);
                break;
            case '1y':
                cutoff.setFullYear(now.getFullYear() - 1);
                break;
            case '2y':
                cutoff.setFullYear(now.getFullYear() - 2);
                break;
            case '3y':
                cutoff.setFullYear(now.getFullYear() - 3);
                break;
            case 'all':
                return null; // No hay fecha de corte
            default:
                cutoff.setMonth(now.getMonth() - 1);
        }
        
        return cutoff.getTime();
    }
    
    // Función para filtrar datos por rango de fechas
    function filterDataByDateRange(times, values, formattedTimes, range) {
        if (range === 'all') {
            return {
                times: times || [],
                values: values || [],
                formattedTimes: formattedTimes || []
            };
        }
        
        // Si no hay datos, retornar vacío
        if (!values || values.length === 0) {
            return {
                times: [],
                values: [],
                formattedTimes: []
            };
        }
        
        const cutoff = getCutoffDate(range);
        const filteredIndices = [];
        
        // Usar times si está disponible, sino usar formattedTimes
        const timeArray = (times && times.length > 0) ? times : formattedTimes;
        
        for (let i = 0; i < timeArray.length && i < values.length; i++) {
            let timestampMs = null;
            
            // Intentar parsear el tiempo (puede ser ISO string o timestamp)
            const timeValue = timeArray[i];
            
            if (typeof timeValue === 'string') {
                // Es un string ISO, parsearlo
                try {
                    timestampMs = new Date(timeValue).getTime();
                } catch (e) {
                    // Si falla el parsing, intentar usar el índice como fallback
                    continue;
                }
            } else if (typeof timeValue === 'number') {
                // Es un número, asumir que es un timestamp en minutos desde 1 ene 2011
                const keepaBaseDate = 1293840000 * 1000; // 1 de enero de 2011 en ms
                timestampMs = timeValue * 60000 + keepaBaseDate;
            } else {
                // Formato desconocido, saltar
                continue;
            }
            
            if (timestampMs && timestampMs >= cutoff) {
                filteredIndices.push(i);
            }
        }
        
        return {
            times: filteredIndices.map(i => (times && times[i]) ? times[i] : null).filter(t => t !== null),
            values: filteredIndices.map(i => values[i]),
            formattedTimes: filteredIndices.map(i => (formattedTimes && formattedTimes[i]) ? formattedTimes[i] : null).filter(t => t !== null)
        };
    }
    
    // Configuración común para todas las gráficas
    const commonChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                labels: {
                    color: 'rgb(226, 232, 240)',
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'rgb(226, 232, 240)',
                bodyColor: 'rgb(226, 232, 240)',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1
            }
        },
        scales: {
            x: {
                ticks: {
                    color: 'rgb(148, 163, 184)',
                    maxRotation: 45,
                    minRotation: 45,
                    maxTicksLimit: 10
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            }
        }
    };
    
    // Función para actualizar un gráfico específico según el rango de fechas
    function updateChart(chartType, range) {
        currentDateRange[chartType] = range;
        
        {% if product.price_history %}
        if (chartType === 'price' && originalPriceHistory && priceChart) {
            const newPrices = originalPriceHistory.NEW || {};
            const amazonPrices = originalPriceHistory.AMAZON || {};
            const usedPrices = originalPriceHistory.USED || {};
            
            // Filtrar datos
            const filteredNew = filterDataByDateRange(
                newPrices.times || [],
                newPrices.prices || [],
                newPrices.formatted_times || [],
                range
            );
            const filteredAmazon = filterDataByDateRange(
                amazonPrices.times || [],
                amazonPrices.prices || [],
                amazonPrices.formatted_times || [],
                range
            );
            const filteredUsed = filterDataByDateRange(
                usedPrices.times || [],
                usedPrices.prices || [],
                usedPrices.formatted_times || [],
                range
            );
            
            // Usar las etiquetas del conjunto más largo
            const labels = filteredNew.formattedTimes.length > filteredAmazon.formattedTimes.length 
                ? filteredNew.formattedTimes 
                : filteredAmazon.formattedTimes;
            
            // Actualizar datos
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = filteredNew.values.map(p => p / 100);
            priceChart.data.datasets[1].data = filteredAmazon.values.map(p => p / 100);
            priceChart.data.datasets[2].data = filteredUsed.values.map(p => p / 100);
            
            // Recalcular rango Y
            const allPrices = [
                ...filteredNew.values.map(p => p / 100),
                ...filteredAmazon.values.map(p => p / 100),
                ...filteredUsed.values.map(p => p / 100)
            ].filter(p => p > 0);
            
            if (allPrices.length > 0) {
                const minPrice = Math.min(...allPrices);
                const maxPrice = Math.max(...allPrices);
                const priceRange = maxPrice - minPrice;
                priceChart.options.scales.y.min = Math.max(0, minPrice - (priceRange * 0.1));
                priceChart.options.scales.y.max = maxPrice + (priceRange * 0.1);
            }
            
            priceChart.update();
        }
        {% endif %}
        
        {% if product.sales_rank_history %}
        if (chartType === 'salesrank' && originalSalesRankHistory && salesRankChart) {
            const filtered = filterDataByDateRange(
                originalSalesRankHistory.times || [],
                originalSalesRankHistory.values || [],
                originalSalesRankHistory.formatted_times || [],
                range
            );
            
            if (filtered.values.length > 0) {
                salesRankChart.data.labels = filtered.formattedTimes;
                salesRankChart.data.datasets[0].data = filtered.values;
                
                // Recalcular rango Y
                const validSalesRanks = filtered.values.filter(s => s > 0);
                if (validSalesRanks.length > 0) {
                    const minSalesRank = Math.min(...validSalesRanks);
                    const maxSalesRank = Math.max(...validSalesRanks);
                    const salesRankRange = maxSalesRank - minSalesRank;
                    salesRankChart.options.scales.y.min = Math.max(0, minSalesRank - (salesRankRange * 0.1));
                    salesRankChart.options.scales.y.max = maxSalesRank + (salesRankRange * 0.1);
                }
                
                salesRankChart.update();
            }
        }
        {% endif %}
        
        {% if product.rating_history %}
        if (chartType === 'rating' && originalRatingHistory && ratingChart) {
            const filtered = filterDataByDateRange(
                originalRatingHistory.times || [],
                originalRatingHistory.values || [],
                originalRatingHistory.formatted_times || [],
                range
            );
            
            if (filtered.values.length > 0) {
                ratingChart.data.labels = filtered.formattedTimes;
                ratingChart.data.datasets[0].data = filtered.values.map(r => r * 10);
                
                ratingChart.update();
            }
        }
        {% endif %}
    }
    
    {% if product.price_history %}
    // Gráfica de Precio
    const priceCtx = document.getElementById('priceChart');
    originalPriceHistory = {{ price_history_json|safe }};
    
    const newPrices = originalPriceHistory.NEW || {};
    const amazonPrices = originalPriceHistory.AMAZON || {};
    const usedPrices = originalPriceHistory.USED || {};
    
    // Filtrar datos iniciales (1 mes por defecto)
    const initialFilteredNew = filterDataByDateRange(
        newPrices.times || [],
        newPrices.prices || [],
        newPrices.formatted_times || [],
        '1m'
    );
    const initialFilteredAmazon = filterDataByDateRange(
        amazonPrices.times || [],
        amazonPrices.prices || [],
        amazonPrices.formatted_times || [],
        '1m'
    );
    const initialFilteredUsed = filterDataByDateRange(
        usedPrices.times || [],
        usedPrices.prices || [],
        usedPrices.formatted_times || [],
        '1m'
    );
    
    // Usar las etiquetas del conjunto más largo
    const priceLabels = initialFilteredNew.formattedTimes.length > initialFilteredAmazon.formattedTimes.length 
        ? initialFilteredNew.formattedTimes 
        : initialFilteredAmazon.formattedTimes;
    
    // Combinar todos los precios filtrados para calcular rango
    const allPrices = [
        ...initialFilteredNew.values.map(p => p / 100),
        ...initialFilteredAmazon.values.map(p => p / 100),
        ...initialFilteredUsed.values.map(p => p / 100)
    ].filter(p => p > 0);
    
    const minPrice = allPrices.length > 0 ? Math.min(...allPrices) : 0;
    const maxPrice = allPrices.length > 0 ? Math.max(...allPrices) : 100;
    const priceRange = maxPrice - minPrice;
    const priceMin = Math.max(0, minPrice - (priceRange * 0.1));
    const priceMax = maxPrice + (priceRange * 0.1);
    
    priceChart = new Chart(priceCtx, {
        type: 'line',
        data: {
            labels: priceLabels,
            datasets: [
                {
                    label: 'Precio Nuevo',
                    data: initialFilteredNew.values.map(p => p / 100),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                },
                {
                    label: 'Precio Amazon',
                    data: initialFilteredAmazon.values.map(p => p / 100),
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                },
                {
                    label: 'Precio Usado',
                    data: initialFilteredUsed.values.map(p => p / 100),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2
                }
            ]
        },
        options: {
            ...commonChartOptions,
            scales: {
                ...commonChartOptions.scales,
                y: {
                    beginAtZero: false,
                    min: priceMin,
                    max: priceMax,
                    ticks: {
                        color: 'rgb(148, 163, 184)',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}
    
    {% if product.sales_rank_history %}
    // Gráfica de Sales Rank
    const salesRankCtx = document.getElementById('salesRankChart');
    originalSalesRankHistory = {{ sales_rank_history_json|safe }};
    
    // Filtrar datos iniciales (1 mes por defecto)
    const initialFilteredSalesRank = filterDataByDateRange(
        originalSalesRankHistory.times || [],
        originalSalesRankHistory.values || [],
        originalSalesRankHistory.formatted_times || [],
        '1m'
    );
    
    const salesRankData = initialFilteredSalesRank.values || [];
    const salesRankTimes = initialFilteredSalesRank.formattedTimes || [];
    
    // Calcular rango para Sales Rank (nota: menor es mejor)
    const validSalesRanks = salesRankData.filter(s => s > 0);
    if (validSalesRanks.length > 0) {
        const minSalesRank = Math.min(...validSalesRanks);
        const maxSalesRank = Math.max(...validSalesRanks);
        const salesRankRange = maxSalesRank - minSalesRank;
        const salesRankMin = Math.max(0, minSalesRank - (salesRankRange * 0.1));
        const salesRankMax = maxSalesRank + (salesRankRange * 0.1);
        
        salesRankChart = new Chart(salesRankCtx, {
            type: 'line',
            data: {
                labels: salesRankTimes,
                datasets: [{
                    label: 'Sales Rank',
                    data: salesRankData,
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                ...commonChartOptions,
                scales: {
                    ...commonChartOptions.scales,
                    y: {
                        beginAtZero: false,
                        min: salesRankMin,
                        max: salesRankMax,
                        reverse: false,
                        ticks: {
                            color: 'rgb(148, 163, 184)',
                            callback: function(value) {
                                return '#' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    } else if (originalSalesRankHistory.values && originalSalesRankHistory.values.length > 0) {
        // Si no hay datos en el último mes, mostrar todos los datos sin filtrar
        const allSalesRankData = originalSalesRankHistory.values || [];
        const allSalesRankTimes = originalSalesRankHistory.formatted_times || [];
        
        const validSalesRanks = allSalesRankData.filter(s => s > 0);
        if (validSalesRanks.length > 0) {
            const minSalesRank = Math.min(...validSalesRanks);
            const maxSalesRank = Math.max(...validSalesRanks);
            const salesRankRange = maxSalesRank - minSalesRank;
            const salesRankMin = Math.max(0, minSalesRank - (salesRankRange * 0.1));
            const salesRankMax = maxSalesRank + (salesRankRange * 0.1);
            
            salesRankChart = new Chart(salesRankCtx, {
                type: 'line',
                data: {
                    labels: allSalesRankTimes,
                    datasets: [{
                        label: 'Sales Rank',
                        data: allSalesRankData,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.1,
                        stepped: 'before',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        ...commonChartOptions.scales,
                        y: {
                            beginAtZero: false,
                            min: salesRankMin,
                            max: salesRankMax,
                            reverse: false,
                            ticks: {
                                color: 'rgb(148, 163, 184)',
                                callback: function(value) {
                                    return '#' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
    }
    {% endif %}
    
    {% if product.rating_history %}
    // Gráfica de Rating
    const ratingCtx = document.getElementById('ratingChart');
    originalRatingHistory = {{ rating_history_json|safe }};
    
    // Filtrar datos iniciales (1 mes por defecto)
    const initialFilteredRating = filterDataByDateRange(
        originalRatingHistory.times || [],
        originalRatingHistory.values || [],
        originalRatingHistory.formatted_times || [],
        '1m'
    );
    
    const ratingData = (initialFilteredRating.values || []).map(r => r * 10);
    const ratingTimes = initialFilteredRating.formattedTimes || [];
    
    if (ratingData.length > 0) {
        ratingChart = new Chart(ratingCtx, {
            type: 'line',
            data: {
                labels: ratingTimes,
                datasets: [{
                    label: 'Calificación',
                    data: ratingData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                ...commonChartOptions,
                scales: {
                    ...commonChartOptions.scales,
                    y: {
                        beginAtZero: false,
                        min: 0,
                        max: 5,
                        ticks: {
                            color: 'rgb(148, 163, 184)',
                            stepSize: 0.5,
                            callback: function(value) {
                                return value.toFixed(1) + ' ⭐';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    } else if (originalRatingHistory.values && originalRatingHistory.values.length > 0) {
        // Si no hay datos en el último mes, mostrar todos los datos sin filtrar
        const allRatingData = (originalRatingHistory.values || []).map(r => r * 10);
        const allRatingTimes = originalRatingHistory.formatted_times || [];
        
        ratingChart = new Chart(ratingCtx, {
            type: 'line',
            data: {
                labels: allRatingTimes,
                datasets: [{
                    label: 'Calificación',
                    data: allRatingData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    stepped: 'before',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                ...commonChartOptions,
                scales: {
                    ...commonChartOptions.scales,
                    y: {
                        beginAtZero: false,
                        min: 0,
                        max: 5,
                        ticks: {
                            color: 'rgb(148, 163, 184)',
                            stepSize: 0.5,
                            callback: function(value) {
                                return value.toFixed(1) + ' ⭐';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Función para actualizar el estado visual de los botones de un gráfico específico
    function updateButtonStyles(chartType, activeButton) {
        let buttonSelector = '';
        let activeBgClass = '';
        let activeBorderClass = '';
        
        if (chartType === 'price') {
            buttonSelector = '.price-chart-btn';
            activeBgClass = 'bg-keepa-blue-500/30';
            activeBorderClass = 'border-keepa-blue-500/50';
        } else if (chartType === 'salesrank') {
            buttonSelector = '.salesrank-chart-btn';
            activeBgClass = 'bg-purple-500/30';
            activeBorderClass = 'border-purple-500/50';
        } else if (chartType === 'rating') {
            buttonSelector = '.rating-chart-btn';
            activeBgClass = 'bg-keepa-green-500/30';
            activeBorderClass = 'border-keepa-green-500/50';
        }
        
        // Remover clase active de todos los botones del mismo gráfico
        const chartButtons = document.querySelectorAll(buttonSelector);
        chartButtons.forEach(btn => {
            btn.classList.remove('active', activeBgClass, activeBorderClass, 'text-white');
            btn.classList.add('bg-white/10', 'border-white/20', 'text-slate-300');
        });
        
        // Agregar clase active al botón clickeado
        activeButton.classList.remove('bg-white/10', 'border-white/20', 'text-slate-300');
        activeButton.classList.add('active', activeBgClass, activeBorderClass, 'text-white');
    }
    
    // Event listeners para los botones de filtro de fecha
    document.addEventListener('DOMContentLoaded', function() {
        const dateFilterButtons = document.querySelectorAll('.date-filter-btn');
        
        dateFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Obtener el tipo de gráfico y el rango del atributo data-chart y data-range
                const chartType = this.getAttribute('data-chart');
                const range = this.getAttribute('data-range');
                
                // Actualizar estilos de botones del gráfico específico
                updateButtonStyles(chartType, this);
                
                // Actualizar solo el gráfico correspondiente
                updateChart(chartType, range);
            });
        });
    });
</script>
{% endblock %}

